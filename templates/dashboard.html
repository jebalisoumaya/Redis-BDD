<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analyse Diabète - Redis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: none;
            border-radius: 10px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
        }
        .stat-card-2 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 15px;
        }
        .stat-card-3 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            border-radius: 15px;
        }
        .stat-card-4 {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            border-radius: 15px;
        }
        .chart-container {
            position: relative;
            height: 400px;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-heartbeat"></i> Dashboard Analyse Diabète - Redis
            </span>
            <span class="navbar-text" id="lastUpdate">
                Dernière mise à jour: <span id="updateTime">--:--</span>
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Statistiques générales -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <h5 class="card-title">Total Patients</h5>
                        <h2 id="totalPatients">--</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card-2">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <h5 class="card-title">Diabétiques</h5>
                        <h2 id="diabeticPatients">--</h2>
                        <small id="diabetesRate">-- %</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card-3">
                    <div class="card-body text-center">
                        <i class="fas fa-birthday-cake fa-2x mb-2"></i>
                        <h5 class="card-title">Âge Moyen</h5>
                        <h2 id="avgAge">--</h2>
                        <small>ans</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card-4">
                    <div class="card-body text-center">
                        <i class="fas fa-tint fa-2x mb-2"></i>
                        <h5 class="card-title">Glucose Moyen</h5>
                        <h2 id="avgGlucose">--</h2>
                        <small>mg/dL</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Distribution par Groupe d'Âge</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="ageGroupChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Distribution par Catégorie BMI</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="bmiChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analyses spécialisées -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-female"></i> Analyse Femmes Enceintes</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="pregnantChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <p><strong>Total femmes enceintes:</strong> <span id="totalPregnant">--</span></p>
                            <p><strong>Avec diabète:</strong> <span id="pregnantDiabetic">--</span></p>
                            <p><strong>Taux:</strong> <span id="pregnantRate">--%</span></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-fire"></i> Top 5 Glucose Élevé</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-sm" id="topGlucoseTable">
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Patient</th>
                                        <th>Glucose</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="4" class="text-center">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-weight"></i> Top 5 BMI Élevé</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-sm" id="topBmiTable">
                                <thead>
                                    <tr>
                                        <th>Rang</th>
                                        <th>Patient</th>
                                        <th>BMI</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="4" class="text-center">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert pour les patients à haut risque -->
        <div class="row">
            <div class="col-12">
                <div class="alert alert-warning" role="alert">
                    <h4 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Patients à Haut Risque</h4>
                    <p>Femmes enceintes + obèses + diabétiques: <strong id="highRiskCount">--</strong> patientes</p>
                    <hr>
                    <p class="mb-0">Ces patientes nécessitent une surveillance médicale renforcée.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales pour les graphiques
        let ageGroupChart, bmiChart, pregnantChart;

        // Fonction pour mettre à jour l'heure
        function updateTime() {
            const now = new Date();
            document.getElementById('updateTime').textContent = now.toLocaleTimeString('fr-FR');
        }

        // Chargement des données
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Erreur Redis:', data.error);
                    return;
                }

                document.getElementById('totalPatients').textContent = data.total_patients;
                document.getElementById('diabeticPatients').textContent = data.diabetic_patients;
                document.getElementById('diabetesRate').textContent = data.diabetes_rate + '%';
                document.getElementById('avgAge').textContent = data.avg_age;
                document.getElementById('avgGlucose').textContent = data.avg_glucose;
            } catch (error) {
                console.error('Erreur lors du chargement des stats:', error);
            }
        }

        async function loadAgeGroups() {
            try {
                const response = await fetch('/api/age_groups');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Erreur:', data.error);
                    return;
                }

                const ctx = document.getElementById('ageGroupChart').getContext('2d');
                
                if (ageGroupChart) {
                    ageGroupChart.destroy();
                }

                ageGroupChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(item => item.group),
                        datasets: [{
                            data: data.map(item => item.diabetic),
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: 'Patients Diabétiques par Âge'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erreur lors du chargement des groupes d\'âge:', error);
            }
        }

        async function loadBmiCategories() {
            try {
                const response = await fetch('/api/bmi_categories');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Erreur:', data.error);
                    return;
                }

                const ctx = document.getElementById('bmiChart').getContext('2d');
                
                if (bmiChart) {
                    bmiChart.destroy();
                }

                bmiChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(item => item.category),
                        datasets: [{
                            label: 'Diabétiques',
                            data: data.map(item => item.diabetic),
                            backgroundColor: '#FF6384'
                        }, {
                            label: 'Non-diabétiques',
                            data: data.map(item => item.non_diabetic),
                            backgroundColor: '#36A2EB'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erreur lors du chargement des catégories BMI:', error);
            }
        }

        async function loadPregnantAnalysis() {
            try {
                const response = await fetch('/api/pregnant_analysis');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Erreur:', data.error);
                    return;
                }

                document.getElementById('totalPregnant').textContent = data.total_pregnant;
                document.getElementById('pregnantDiabetic').textContent = data.diabetic_pregnant;
                document.getElementById('pregnantRate').textContent = data.diabetes_rate + '%';

                const ctx = document.getElementById('pregnantChart').getContext('2d');
                
                if (pregnantChart) {
                    pregnantChart.destroy();
                }

                pregnantChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Avec diabète', 'Sans diabète'],
                        datasets: [{
                            data: [data.diabetic_pregnant, data.non_diabetic_pregnant],
                            backgroundColor: ['#FF6384', '#36A2EB'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erreur lors du chargement de l\'analyse grossesse:', error);
            }
        }

        async function loadTopGlucose() {
            try {
                const response = await fetch('/api/top_glucose');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Erreur:', data.error);
                    return;
                }

                const tbody = document.querySelector('#topGlucoseTable tbody');
                tbody.innerHTML = data.slice(0, 5).map(item => `
                    <tr>
                        <td>${item.rank}</td>
                        <td>${item.patient_id}</td>
                        <td>${item.glucose}</td>
                        <td><span class="badge ${item.outcome === 'Diabétique' ? 'bg-danger' : 'bg-success'}">${item.outcome}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erreur lors du chargement du top glucose:', error);
            }
        }

        async function loadTopBmi() {
            try {
                const response = await fetch('/api/top_bmi');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Erreur:', data.error);
                    return;
                }

                const tbody = document.querySelector('#topBmiTable tbody');
                tbody.innerHTML = data.slice(0, 5).map(item => `
                    <tr>
                        <td>${item.rank}</td>
                        <td>${item.patient_id}</td>
                        <td>${item.bmi}</td>
                        <td><span class="badge ${item.outcome === 'Diabétique' ? 'bg-danger' : 'bg-success'}">${item.outcome}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erreur lors du chargement du top BMI:', error);
            }
        }

        async function loadHighRiskAnalysis() {
            try {
                const response = await fetch('/api/high_risk_analysis');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Erreur:', data.error);
                    return;
                }

                document.getElementById('highRiskCount').textContent = data.high_risk_count;
            } catch (error) {
                console.error('Erreur lors du chargement de l\'analyse haut risque:', error);
            }
        }

        // Fonction principale de chargement
        async function loadDashboard() {
            updateTime();
            await Promise.all([
                loadStats(),
                loadAgeGroups(),
                loadBmiCategories(),
                loadPregnantAnalysis(),
                loadTopGlucose(),
                loadTopBmi(),
                loadHighRiskAnalysis()
            ]);
        }

        // Chargement initial et mise à jour périodique
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            
            // Mise à jour toutes les 30 secondes
            setInterval(loadDashboard, 30000);
        });
    </script>
</body>
</html>